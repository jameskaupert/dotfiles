#!/bin/bash
set -e

echo "üöÄ Setting up Arch development environment..."

# System packages
echo "üì¶ Installing system packages..."
sudo pacman -Syu --noconfirm
sudo pacman -S --noconfirm base-devel git curl wget unzip docker docker-compose wezterm

# Docker setup
echo "üê≥ Setting up Docker..."
sudo systemctl enable docker
sudo systemctl start docker
sudo usermod -aG docker $USER

# AUR helper
echo "üì¶ Installing AUR helper..."
if ! command -v yay &> /dev/null; then
    cd /tmp
    git clone https://aur.archlinux.org/yay.git
    cd yay
    makepkg -si --noconfirm
    cd ~
fi

# Mise
echo "üîß Installing mise..."
curl https://mise.run | sh
export PATH="$HOME/.local/bin:$PATH"

# Chezmoi
echo "üè† Setting up chezmoi..."
sudo pacman -S --noconfirm chezmoi
if [ ! -z "$DOTFILES_REPO" ]; then
    chezmoi init --apply $DOTFILES_REPO
fi

# Zsh setup
echo "üêö Setting up zsh..."

# Install zsh if not already installed
sudo pacman -S --noconfirm zsh zsh-completions

# Change default shell to zsh
if command -v zsh >/dev/null; then
    echo "Changing default shell to zsh..."
    sudo chsh -s $(command -v zsh) $USER
    echo "‚ö†Ô∏è  You'll need to log out and back in for shell change to take effect"
fi

# Verify zsh installation
if command -v zsh &> /dev/null; then
    echo "‚úÖ Zsh installed successfully"
    zsh --version
else
    echo "‚ùå Zsh installation failed"
    exit 1
fi

# oh-my-posh install
curl -s https://ohmyposh.dev/install.sh | bash -s

# zoxide install
curl -sSfL https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | sh

